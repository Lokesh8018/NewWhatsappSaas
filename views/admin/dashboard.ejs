<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard â€” WA Gateway</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; }
    nav { background: #25d366; padding: 0 24px; height: 56px; display: flex; align-items: center; justify-content: space-between; }
    nav h1 { color: white; font-size: 18px; font-weight: 700; }
    nav a { color: rgba(255,255,255,0.85); text-decoration: none; font-size: 14px; }
    nav a:hover { color: white; }
    .main { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .stat-card .value { font-size: 32px; font-weight: 700; color: #25d366; }
    .stat-card .label { font-size: 13px; color: #666; margin-top: 4px; }
    .section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; }
    .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px 12px; font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; border-bottom: 1px solid #f0f0f0; }
    td { padding: 12px; font-size: 14px; border-bottom: 1px solid #f8f8f8; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-connected { background: #d1e7dd; color: #0f5132; }
    .badge-disconnected { background: #f8d7da; color: #842029; }
    .badge-connecting { background: #fff3cd; color: #856404; }
    .badge-qr_ready { background: #cfe2ff; color: #0a58ca; }
    .badge-pairing { background: #e2d9f3; color: #432874; }
    .btn { padding: 7px 14px; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .btn-green { background: #25d366; color: white; }
    .btn-green:hover { background: #1ebe5d; }
    .btn-red { background: #dc3545; color: white; }
    .btn-red:hover { background: #bb2d3b; }
    .btn-yellow { background: #ffc107; color: #000; }
    .btn-yellow:hover { background: #ffca2c; }
    .btn-blue { background: #0d6efd; color: white; }
    .btn-blue:hover { background: #0b5ed7; }
    .btn-gray { background: #6c757d; color: white; }
    .btn-gray:hover { background: #5c636a; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 12px; padding: 24px; max-width: 480px; width: 90%; }
    .modal h2 { font-size: 18px; margin-bottom: 16px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #25d366; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
    .alert { padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-top: 10px; }
    .alert-success { background: #d1e7dd; color: #0f5132; }
    .alert-error { background: #f8d7da; color: #842029; }
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .actions { display: flex; gap: 6px; flex-wrap: wrap; }
    @media (max-width: 600px) { table, thead, tbody, th, td, tr { display: block; } thead tr { position: absolute; top: -9999px; left: -9999px; } td { border: none; padding: 6px 12px; } td:before { font-weight: 700; content: attr(data-label) ': '; } }
  </style>
</head>
<body>
  <nav>
    <h1>ðŸ“± WA Gateway Admin</h1>
    <a href="/admin/logout">Logout</a>
  </nav>

  <div class="main">
    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <div class="value" id="totalSessions">â€”</div>
        <div class="label">Total Sessions</div>
      </div>
      <div class="stat-card">
        <div class="value" id="activeSessions" style="color:#25d366">â€”</div>
        <div class="label">Active Sessions</div>
      </div>
      <div class="stat-card">
        <div class="value" id="disconnectedSessions" style="color:#dc3545">â€”</div>
        <div class="label">Disconnected</div>
      </div>
    </div>

    <!-- Sessions Table -->
    <div class="section">
      <div class="section-title">
        <span>WhatsApp Sessions</span>
        <div style="display:flex;gap:8px">
          <button class="btn btn-green btn-sm" onclick="window.location.href='/pair'">+ Link New</button>
          <button class="btn btn-blue btn-sm" onclick="loadSessions()">â†» Refresh</button>
        </div>
      </div>
      <div id="sessionsContainer">
        <div class="empty-state">Loading sessions...</div>
      </div>
    </div>

    <!-- Send Message -->
    <div class="section">
      <div class="section-title">Send Message</div>
      <div class="form-group">
        <label>Session</label>
        <select id="msgSession">
          <option value="">â€” Select Session â€”</option>
        </select>
      </div>
      <div class="form-group">
        <label>Recipient Number</label>
        <input type="text" id="msgNumber" placeholder="e.g. 628123456789" />
      </div>
      <div class="form-group">
        <label>Message</label>
        <textarea id="msgText" placeholder="Type your message..."></textarea>
      </div>
      <button class="btn btn-green" onclick="sendMessage()">Send Message</button>
      <div id="sendResult"></div>
    </div>

    <!-- Bulk Message -->
    <div class="section">
      <div class="section-title">Bulk Message</div>
      <div class="form-group">
        <label>Session</label>
        <select id="bulkSession">
          <option value="">â€” Select Session â€”</option>
        </select>
      </div>
      <div class="form-group">
        <label>Recipients (one per line or comma-separated)</label>
        <textarea id="bulkNumbers" placeholder="628123456789&#10;628987654321" style="min-height:100px"></textarea>
      </div>
      <div class="form-group">
        <label>Message</label>
        <textarea id="bulkText" placeholder="Type your message..."></textarea>
      </div>
      <button class="btn btn-green" onclick="sendBulk()" id="bulkBtn">Send Bulk</button>
      <div id="bulkResult"></div>
    </div>
  </div>

  <script>
    let sessions = [];

    async function loadSessions() {
      try {
        const res = await fetch('/admin/api/sessions');
        const data = await res.json();
        if (data.status) {
          sessions = data.sessions;
          renderSessions(sessions);
          updateStats(sessions);
          updateSessionDropdowns(sessions);
        }
      } catch (e) {
        document.getElementById('sessionsContainer').innerHTML = '<div class="empty-state">Error loading sessions</div>';
      }
    }

    function updateStats(sessions) {
      document.getElementById('totalSessions').textContent = sessions.length;
      document.getElementById('activeSessions').textContent = sessions.filter(s => s.status === 'connected').length;
      document.getElementById('disconnectedSessions').textContent = sessions.filter(s => s.status === 'disconnected').length;
    }

    function updateSessionDropdowns(sessions) {
      const connected = sessions.filter(s => s.status === 'connected');
      const opts = '<option value="">â€” Select Session â€”</option>' + connected.map(s =>
        `<option value="${s.sessionId}">${s.name || s.sessionId} (${s.phoneNumber || 'unknown'})</option>`
      ).join('');
      document.getElementById('msgSession').innerHTML = opts;
      document.getElementById('bulkSession').innerHTML = opts;
    }

    function renderSessions(sessions) {
      if (!sessions.length) {
        document.getElementById('sessionsContainer').innerHTML = '<div class="empty-state">No sessions found. <a href="/pair">Link a WhatsApp number</a> to get started.</div>';
        return;
      }
      const rows = sessions.map(s => `
        <tr>
          <td data-label="Name"><strong>${escHtml(s.name || s.sessionId)}</strong></td>
          <td data-label="Number">${escHtml(s.phoneNumber || 'â€”')}</td>
          <td data-label="Status"><span class="badge badge-${s.status}">${s.status}</span></td>
          <td data-label="Created">${s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'â€”'}</td>
          <td data-label="Last Active">${s.lastConnected ? new Date(s.lastConnected).toLocaleString() : 'â€”'}</td>
          <td data-label="Actions">
            <div class="actions">
              ${s.status === 'disconnected' ? `<button class="btn btn-yellow btn-sm" onclick="reconnect('${s.sessionId}')">Reconnect</button>` : ''}
              ${s.status === 'connected' ? `<button class="btn btn-gray btn-sm" onclick="disconnect('${s.sessionId}')">Disconnect</button>` : ''}
              <button class="btn btn-red btn-sm" onclick="deleteSession('${s.sessionId}')">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
      document.getElementById('sessionsContainer').innerHTML = `
        <table>
          <thead><tr>
            <th>Name</th><th>Number</th><th>Status</th><th>Created</th><th>Last Active</th><th>Actions</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function escHtml(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    async function reconnect(sessionId) {
      if (!confirm('Reconnect session ' + sessionId + '?')) return;
      const res = await fetch('/admin/api/sessions/' + sessionId + '/reconnect', { method: 'POST' });
      const data = await res.json();
      alert(data.message);
      loadSessions();
    }

    async function disconnect(sessionId) {
      if (!confirm('Disconnect session ' + sessionId + '?')) return;
      const res = await fetch('/admin/api/sessions/' + sessionId + '/disconnect', { method: 'POST' });
      const data = await res.json();
      alert(data.message);
      loadSessions();
    }

    async function deleteSession(sessionId) {
      if (!confirm('Delete session ' + sessionId + '? This cannot be undone.')) return;
      const res = await fetch('/admin/api/sessions/' + sessionId, { method: 'DELETE' });
      const data = await res.json();
      alert(data.message);
      loadSessions();
    }

    async function sendMessage() {
      const sessionId = document.getElementById('msgSession').value;
      const number = document.getElementById('msgNumber').value.trim();
      const message = document.getElementById('msgText').value.trim();
      if (!sessionId || !number || !message) { showResult('sendResult', false, 'Please fill all fields'); return; }

      const res = await fetch('/admin/api/send-message', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId, number, message })
      });
      const data = await res.json();
      showResult('sendResult', data.status, data.message || (data.status ? 'Sent!' : 'Failed'));
    }

    async function sendBulk() {
      const sessionId = document.getElementById('bulkSession').value;
      const numbers = document.getElementById('bulkNumbers').value.trim();
      const message = document.getElementById('bulkText').value.trim();
      if (!sessionId || !numbers || !message) { showResult('bulkResult', false, 'Please fill all fields'); return; }

      document.getElementById('bulkBtn').disabled = true;
      document.getElementById('bulkBtn').textContent = 'Sending...';
      try {
        const res = await fetch('/admin/api/send-bulk', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, numbers, message })
        });
        const data = await res.json();
        if (data.results) {
          const sent = data.results.filter(r => r.status === 'sent').length;
          showResult('bulkResult', true, `Sent: ${sent}/${data.results.length}`);
        } else {
          showResult('bulkResult', data.status, data.message);
        }
      } finally {
        document.getElementById('bulkBtn').disabled = false;
        document.getElementById('bulkBtn').textContent = 'Send Bulk';
      }
    }

    function showResult(id, success, msg) {
      const el = document.getElementById(id);
      el.innerHTML = `<div class="alert ${success ? 'alert-success' : 'alert-error'}">${escHtml(msg)}</div>`;
    }

    loadSessions();
    const SESSION_REFRESH_INTERVAL_MS = 15000;
    setInterval(loadSessions, SESSION_REFRESH_INTERVAL_MS);
  </script>
</body>
</html>
